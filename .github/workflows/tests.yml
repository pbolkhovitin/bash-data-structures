name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Run Test Suite
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –≤–µ—Ä—Å–∏–∏ —á–µ—Ä–µ–∑ –æ–±–æ–ª–æ—á–∫–∏ Docker
        bash-container: ["bash:4.4", "bash:5.1", "bash:5.2"]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Test with Bash ${{ matrix.bash-container }}
      run: |
        echo "Testing with ${{ matrix.bash-container }}"
        docker run --rm -v $PWD:/workspace -w /workspace ${{ matrix.bash-container }} \
          bash -c "
            echo 'Bash version: $(bash --version | head -n1)'
            find . -name '*.sh' -type f -exec chmod +x {} \;
            echo 'üîç Checking Bash syntax...'
            find src/ lib/ tests/ examples/ -name '*.sh' -type f | while read file; do
              echo 'Checking \$file'
              bash -n \"\$file\" || exit 1
            done
            echo 'üß™ Running tests...'
            cd tests
            ./test_stack.sh
            ./test_framework.sh
            ./integration_test.sh
          "

    - name: Upload test logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-logs-${{ matrix.bash-container }}
        path: |
          /tmp/bash-ds-logs/
          /var/log/bash-ds/
        retention-days: 7