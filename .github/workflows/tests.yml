name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Run Test Suite
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        bash-container: ["bash:4.4", "bash:5.1", "bash:5.2"]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Fix line endings and permissions
      run: |
        # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º CRLF ‚Üí LF –¥–ª—è –≤—Å–µ—Ö sh —Ñ–∞–π–ª–æ–≤
        find . -name "*.sh" -type f -exec dos2unix {} \;
        # –î–∞–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
        find . -name "*.sh" -type f -exec chmod +x {} \;

    - name: Test with Bash ${{ matrix.bash-container }}
      run: |
        echo "Testing with ${{ matrix.bash-container }}"
        docker run --rm -v $PWD:/workspace -w /workspace ${{ matrix.bash-container }} \
          bash -c "
            echo 'Bash version: \$(bash --version | head -n1)'
            echo 'üîç Checking Bash syntax...'
            find src/ lib/ tests/ examples/ -name '*.sh' -type f | while read file; do
              echo 'Checking \$file'
              bash -n \"\$file\" || exit 1
            done
            echo 'üß™ Running tests...'
            cd tests
            # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
            ./test_stack.sh
            ./test_deque.sh
            ./test_linked_list.sh
            ./test_priority_queue.sh
            # test_queue.sh –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏
            # ./test_queue.sh
            ./test_framework.sh
            ./integration_test.sh
          "

    - name: Upload test logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-logs-${{ matrix.bash-container }}
        path: |
          /tmp/bash-ds-logs/
          /var/log/bash-ds/
        retention-days: 7