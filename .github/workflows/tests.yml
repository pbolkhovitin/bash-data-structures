name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Run Test Suite
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Fix file encoding and permissions
      run: |
        sudo apt-get update
        sudo apt-get install -y dos2unix
        # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
        find . -name "*.sh" -type f -exec dos2unix {} \;
        # –£–¥–∞–ª—è–µ–º BOM –º–∞—Ä–∫–µ—Ä—ã –µ—Å–ª–∏ –µ—Å—Ç—å
        find . -name "*.sh" -type f -exec sed -i '1s/^\xEF\xBB\xBF//' {} \;
        find . -name "*.sh" -type f -exec chmod +x {} \;
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        echo "–§–æ—Ä–º–∞—Ç—ã —Ñ–∞–π–ª–æ–≤ –ø–æ—Å–ª–µ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏:"
        file tests/*.sh

    - name: Run syntax check
      run: |
        echo "üîç Checking Bash syntax..."
        find src/ lib/ tests/ examples/ -name "*.sh" -type f | while read file; do
          echo "Checking $file"
          bash -n "$file" && echo "‚úÖ $file" || (echo "‚ùå $file"; exit 1)
        done

    - name: Run tests
      run: |
        echo "üß™ Running tests..."
        cd tests
        
        echo "=== Test Stack ==="
        bash test_stack.sh
        
        echo "=== Test Deque ==="  
        bash test_deque.sh
        
        echo "=== Test Linked List ==="
        bash test_linked_list.sh
        
        echo "=== Test Priority Queue ==="
        bash test_priority_queue.sh
        
        echo "=== Test Queue ==="
        bash test_queue.sh
        
        echo "=== Test Framework ==="
        bash test_framework.sh
        
        echo "=== Integration Test ==="
        bash integration_test.sh

    - name: Upload test logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-logs
        path: |
          /tmp/bash-ds-logs/
          /var/log/bash-ds/
        retention-days: 7